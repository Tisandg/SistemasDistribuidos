/*
 * This is sample code generated by rpcgen.
 * These are only templates and you can use them
 * as a guideline for developing your own functions.
 */

#include "interfaz.h"
#include <stdio.h>

int tam_usuario = 0;
int tam_tablero = 0;

void menuInicioAdmin(){
	printf("\n\n**************  Menu Administrador  **************\n");
	printf("| 1. Iniciar Sesion                             |\n");
	printf("| 2. Salir                                      |\n");
	printf("*************************************************\n");
}
/* 14 asteriscos lado y lado. 2 espacios entre los asteriscos y el titulo del menu
*/
void menuInicioUser(){
	printf("\n\n**************  Menu Usuario  **************\n");
	printf("| 1. Iniciar Sesion                             |\n");
	printf("| 2. Registrarse                                |\n");
	printf("| 3. Salir                                      |\n");
	printf("*************************************************\n");
}

void menuInicio(){
	printf("\n\n**************  Bienvenido  **************\n");
	printf("| 1. Administrador                              |\n");
	printf("| 2. Usuario                                    |\n");
	printf("| 3. Salir                                      |\n");
	printf("*************************************************\n");
}

void menuJuego()
{
	printf("\n\n**************  Domino RPC  **************\n");
	printf("| 1. Empezar partida                            |\n");
	printf("| 2. Consultar estadisticas                     |\n");
	printf("| 3. Salir del juego                            |\n");
	printf("*************************************************\n");
}

void menuPartida(){
	printf("\n\n**************  Partida Domino RPC  **************\n");
	printf("| 1. Jugar ficha                                |\n");
	printf("| 2. Consultar tablero                          |\n");
	printf("| 3. Salir de la partida                        |\n");
	printf("*************************************************\n");
}

void menuAdministrador(){
	printf("\n\n**************  Funciones administrador  **************\n");
	printf("| 1. Modificar datos usuario                    |\n");
	printf("| 2. Listar Usuarios                            |\n");
	printf("| 3. Eliminar Usuario                           |\n");
	printf("| 4. Salir                                      |\n");
	printf("*************************************************\n");
}

void menuTamFichas(){
	printf("\nPor favor eliga un tamaño\n");
	printf("| 1. 16                 |\n");
	printf("| 2. 18                 |\n");
	printf("| 3. 20                 |\n");
	printf("| 4. 22                 |\n");
	printf("| 5. 24                 |\n");
	printf("| 6. 26                 |\n");
	printf("| 7. 28                 |\n");
}

int menu_jugando(){
	int opc = 0;
	printf("********* Usuario Vs Servidor ********\n");
	printf("| 1. Elegir ficha                 |\n");
	printf("| 2. Salir de juego               |\n\n");
	printf("Elige una opcion: ");
	scanf("%d",&opc);
	return opc;
}

void Imprimir_Fichas(fichas *estado, int tam){
	int i = 0;
	while(i < tam){
		printf("Ficha[%d] =	[ %d | %d ]\n", (*estado).fichasJugadores[i].id, 
			(*estado).fichasJugadores[i].lado_A,(*estado).fichasJugadores[i].lado_B);
		i++;
	}
}

int tamanoChar(char tabla[]){
	int tam=0;
	while (tabla[tam]!='\0'){ 
		tam++;
	}
	return tam;
}


void (*funcionM) ();

int validarUsuario(nodo_usuario * usuario){

	int nnombre = sizeof((*usuario).nombres)/sizeof(char);
	if(nnombre > 30)
	{
		printf("El nombre no debe superar los 30 caracteres!\n");
		return 0;
	}

	int napellido = sizeof((*usuario).apellidos)/sizeof(char);
	if(napellido > 20)
	{
		printf("El apellido no debe superar los 20 caracteres!\n");
		return 0;
	}

	int nlogin = sizeof((*usuario).login)/sizeof(int);
	if(nlogin > 10){
		printf("El login no debe superar los 10 caracteres!\n");
		return 0;
	}

	int ncontrasena = sizeof((*usuario).contrasena)/sizeof(int);
	if(ncontrasena < 8 || ncontrasena > 15){
		printf("La contraseña no puede ser menor a 8 y mayor a 15 caracteres!\n");
		return 0;
	}
	return 1;
}

int validarDatos(datosValidar * datos){

	int nlogin = sizeof((*datos).login)/sizeof(int);
	if(nlogin < 8 || nlogin > 15){
		printf("El login no puede ser menor a 8 y mayor a 15 caracteres!\n");
		return 0;
	}

	int ncontrasena = sizeof((*datos).contrasena)/sizeof(int);
	if(ncontrasena < 8 || ncontrasena > 15){
		printf("La contraseña no puede ser menor a 8 y mayor a 15 caracteres!\n");
		return 0;
	}
	return 1;
}

/////////////////////////////////////////////////////
void
gestion_usuario_1(char *host)
{
	CLIENT *clnt;
	bool_t  *result_1;
	datosValidar  autenticar_usuario_1_arg;
	bool_t  *result_2;
	proxNodo  registrarusuario_1_arg;
	proxNodo  *result_3;
	char *listarusuarios_1_arg;
	bool_t  *result_4;
	datosValidar  eliminar_usuario_1_arg;
	bool_t  *result_5;
	proxNodo  modificar_usuario_1_arg;
	nodo_usuario  *result_6;
	datosValidar  consultarusuario_1_arg;
	fichas  *result_7;
	int  repartir_fichas_1_arg;
	fichas  *result_8;
	char *empezar_partida_1_arg;
	fichas  *result_9;
	int  enviar_jugada_1_arg;
	fichas  *result_10;
	char *estado_tablero_1_arg;
	fichas  *result_11;
	char *estado_cliente_1_arg;
	int  *result_12;
	char *contar_puntos_1_arg;
	char * *result_13;
	char *consultar_estadisticas_1_arg;
	bool_t  *result_14;
	char *salir_1_arg;

/*Estructuras auxiliares*/
	nodo_usuario usuarionuevo;
	datosValidar  datos;
	int opcion1, opcionAux = 0, indice;
	int jugadas = 0;


#ifndef	DEBUG
	clnt = clnt_create (host, gestion_usuario, gestion_usuario_version, "udp");
	if (clnt == NULL) {
		clnt_pcreateerror (host);
		exit (1);
	}
#endif	/* DEBUG */

/*Empieza la copias de las lineas*/
		do{
		menuInicio();//Para seleccionar administrador o usuario
		printf("Seleccione una opcion: ");
		scanf("%d",&opcion1);
		printf("\n");
		switch(opcion1){

			/*ADMINISTRADOR*/
			case  1:
				do{
					menuInicioAdmin();
					printf("Seleccione una opcion: ");
					scanf("%d",&opcionAux);
					printf("\n");
					switch(opcionAux){
					/*Iniciar sesion*/
					case 1:
						//datosValidar datos;
						printf("Por favor ingrese los siguientes datos:");
						printf("\nLogin Administrador: ");
						scanf("%d",&datos.login);
						int nlogin = sizeof(datos.login)/sizeof(char);
						//printf(" %d tamaño \n", nlogin);
						while(nlogin < 2 || nlogin > 15){
							printf("El login no puede ser menor a 3 y mayor a 15 caracteres!\n");
							printf("Vuelva a digitar el login: ");
							scanf("%d",&datos.login);
							nlogin = sizeof(datos.login)/sizeof(char);
						}

						printf("Contraseña administrador: ");
						scanf("%s",datos.contrasena);
						int ncontrasena = sizeof(datos.contrasena)/sizeof(char);

						while(ncontrasena < 6 || ncontrasena > 15){
							printf("La contraseña no puede ser menor a 6 y mayor a 15 caracteres!\n");
							printf("Vuelva a digitar la contrasena: ");
							scanf("%s",datos.contrasena);
							ncontrasena = sizeof(datos.contrasena)/sizeof(char);
						}
						datos.permiso = 0;
						autenticar_usuario_1_arg = (datos);

						result_1 = autenticar_usuario_1(&autenticar_usuario_1_arg, clnt);
						if (*result_1 == FALSE) {
							printf("No se ha encontrado el administrador\n");
							clnt_perror (clnt, "call failed");//No se encuentra el administrador
						}else{
							printf("\nSESION INICIADA!");
							int opcionAdmin;
							datosValidar datosAuxiliar;
							do{
								menuAdministrador();
								printf("Seleccione una opcion: ");
								scanf("%d",&opcionAdmin);
								printf("\n");
								switch(opcionAdmin){

									/*Modificar datos*/
									case 1:

										printf("\n-------MODIFICAR USUARIO-------\n");
										char * contrasena = (char*)malloc(sizeof(char));
										int login;

										printf("\nDigite el login del usuario: ");
										scanf("%d",&consultarusuario_1_arg.login);
										printf("Digite la contraseña del usuario: ");
										scanf("%s", consultarusuario_1_arg.contrasena);
										fflush(stdin);

										result_6 = consultarusuario_1(&consultarusuario_1_arg, clnt);
										if (result_6->login ==NULL) {
											printf("Usuario no encontrado");
											clnt_perror (clnt, "call failed");
									
										}else{
											printf("\nUSUARIO ENCONTRADO");
											/*Imprimiendo datos del usuario*/
											printf("\nNombre del usuario: %s \n",(*result_6).nombres);
											printf("Apellido del usuario: %s \n",(*result_6).apellidos);
											printf("login del usuario: %d\n", (*result_6).login);
	
											/*Al modificar volvemos a pedir todos los datos del usuario*/
											printf("\nMODIFICAR DATOS USUARIO:");
											printf("A continuacion, digite los nuevos datos para el usuario.");
											printf("\nDigite nombre del usuario: ");
											scanf("%s", usuarionuevo.nombres);
											fflush(stdin);
											int nnombre = tamanoChar(usuarionuevo.nombres);
											//printf("tamano nombre: %d",nnombre);
											while(nnombre > 30){
												printf("El nombre no debe superar los 30 caracteres!\n");
												printf("Vuelva a digitar el nombre: ");
												scanf("%s", usuarionuevo.nombres);
												nnombre = tamanoChar(usuarionuevo.nombres);
											}

											printf("Digite apellido del usuario: ");
											scanf("%s", usuarionuevo.apellidos);
											fflush(stdin);
											int napellido = tamanoChar(usuarionuevo.apellidos);
											//printf("tamano apellidos: %d",napellido);
											while(napellido > 20){
												printf("El apellido no debe superar los 20 caracteres!\n");
												printf("Vuelva a digitar el apellido: ");
												scanf("%s", usuarionuevo.apellidos);
												fflush(stdin);
												napellido = tamanoChar(usuarionuevo.apellidos);
											}

											usuarionuevo.login = (*result_6).login;
											/*printf("\nDigite el login del usuario: \n");
											scanf("%d", &usuarionuevo.login);
											fflush(stdin);
											int nlogin = sizeof(usuarionuevo.login);///sizeof(char);
											printf("Tamano login %d", nlogin);
											while(nlogin > 10){
												printf("El login no debe superar los 10 caracteres!\n");
												printf("Vuelva a digitar el login: ");
												scanf("%d", &usuarionuevo.login);
												nlogin = sizeof(usuarionuevo.login)/sizeof(char);
											}*/


											printf("Digite la contraseña del usuario: ");
											scanf("%s", usuarionuevo.contrasena);
											fflush(stdin);
											int ncontrasena = tamanoChar(usuarionuevo.contrasena);
											while(ncontrasena < 8 || ncontrasena > 15){
												printf("La contraseña no puede ser menor a 8 y mayor a 15 caracteres!\n");
												printf("Vuelva a digitar la contrasena: ");
												scanf("%s", usuarionuevo.contrasena);
												ncontrasena = tamanoChar(usuarionuevo.contrasena);
											}

											usuarionuevo.permiso = 1;
											usuarionuevo.nodoSiguiente = NULL;
											modificar_usuario_1_arg = &(usuarionuevo);

											eliminar_usuario_1_arg = consultarusuario_1_arg;

											result_4 = eliminar_usuario_1(&eliminar_usuario_1_arg, clnt);
											if (result_4 == (bool_t *) NULL || result_4 == FALSE) {
												printf("No se ha podido modificar el usuario");
												clnt_perror (clnt, "call failed");
											}else{
												/*Se ha eliminado el registro del usuario
												* Se procede a crear un nuevo registro con los datos actualizados*/	
												registrarusuario_1_arg = &usuarionuevo;
												result_2 = registrarusuario_1(&registrarusuario_1_arg, clnt);
												if (result_2 == (bool_t *) NULL) {
													clnt_perror (clnt, "call failed");
												}else{
													printf("\nRegistro se ha modificado correctamente");
												}						
											}

											/*result_5 = modificar_usuario_1(&modificar_usuario_1_arg, clnt);
											if (*result_5 == FALSE) {
												printf("No se ha podido modificar el usuario");
												clnt_perror (clnt, "call failed");
											}
											else
											{
												printf("\nSe ha modificado el usuario correctamente:\n");
												printf("\nDatos del nuevo usuario");
												printf("\nNombre del usuario: %s \n",(*result_3)->nombres);
												printf("Apellido del usuario: %s \n",(*result_3)->apellidos);
												printf("login del usuario: %d\n\n", (*result_3)->login);
											}*/			
										}

										break;
	
									/*Listar Usuarios*/
									case 2:
										printf("\n-------LISTADO DE USUARIOS-------\n");
										int cont = 1;
										result_3 = listarusuarios_1((void*)&listarusuarios_1_arg, clnt);
										if (result_3 == (proxNodo *) NULL) {
											clnt_perror (clnt, "call failed");
										}else{
											while((*result_3) != NULL)
											{
												printf("Identificacion del usuario %d: [%d] %s %s\n", 
												cont, (*result_3)->login,(*result_3)->nombres, (*result_3)->apellidos);
												(*result_3) = (*result_3)->nodoSiguiente;
												cont++;
											}
										}
										break;

									/*Eliminar usuario*/
									case 3:
										
										printf("\n-------ELIMINAR USUARIO-------\n");
										printf("\nPor favor, digite el login y la contrasena del usuario a eliminar");
										printf("\nDigite el login del usuario: ");
										scanf("%d", &datosAuxiliar.login);
										fflush(stdin);
										int nlogin = sizeof(datosAuxiliar.login)/sizeof(int);
										if(nlogin > 10){
											printf("El login no debe superar los 10 caracteres!\n");
											break;
										}

										printf("Digite la contraseña del usuario: ");
										scanf("%s", datosAuxiliar.contrasena);
										fflush(stdin);
										int ncontrasena = sizeof(datosAuxiliar.contrasena)/sizeof(int);
										if(ncontrasena < 8 || ncontrasena > 15){
											printf("La contraseña no puede ser menor a 8 y mayor a 15 caracteres!\n");
											//break;
										}
										datosAuxiliar.permiso = 1;
										consultarusuario_1_arg = (datosAuxiliar);
										/*Consultar si existe el usuario*/
										result_6 = consultarusuario_1(&consultarusuario_1_arg, clnt);
										if (result_6 == (nodo_usuario *) NULL) {
											clnt_perror (clnt, "call failed");
										}else{
											eliminar_usuario_1_arg = (datosAuxiliar);
											/*Se ha encontrado el usuario*/
											result_4 = eliminar_usuario_1(&eliminar_usuario_1_arg, clnt);
											if (result_4 == (bool_t *) NULL) {
												clnt_perror (clnt, "call failed");
											}else{
												printf("\nEl usuario ha sido eliminado!.");									
											}
										}
										
										break;

									/*Salir*/
									case 4:
										printf("\nVolviendo al menu del administrador...");
										break;	
									default:
										printf("\nOpcion invalida");
										break;						
								}	
							}while(opcionAdmin != 4);							

						}

						break;
		
					/*SALIR*/
					case 2:
						printf("\nVolviendo al menu principal...");
						break;

					default:
						printf("\nOpcion no valida");
						break;
				}
				}while(opcionAux != 2);
				break;
			
			/*USUARIO*/
			case  2:
				opcionAux = 0;
				int nlogin;
				int ncontrasena;
				do{
					menuInicioUser();
					printf("Seleccione una opcion: ");
					scanf("%d",&opcionAux);
					printf("\n");
					switch(opcionAux){

						/*Iniciar sesion*/
						case 1:
							printf("Por favor ingrese los siguientes datos\n");
							printf("Login: ");
							scanf("%d",&datos.login);
							nlogin = sizeof(datos.login)/sizeof(char);
							if(nlogin > 10){
								printf("El login no puede ser menor a 10 caracteres!\n");
								break;
							}

							printf("Contraseña: ");
							scanf("%s",datos.contrasena);
							int ncontrasena = sizeof(datos.contrasena)/sizeof(char);
							if(ncontrasena > 30){
								printf("La contraseña no puede ser menor a 8 y mayor a 15 caracteres!\n");
								break;
							}
							datos.permiso = 1;
							autenticar_usuario_1_arg = (datos);

							result_1 = autenticar_usuario_1(&autenticar_usuario_1_arg, clnt);
							if (*result_1 == FALSE) {
								printf("\nUsuario no encontrado\n");
								clnt_perror (clnt, "call failed");
							}else{
								printf("\nSESION INICIADA!");
							
								/*Menu del juego*/
								int opcionJuego;
								int opcionFichas = 0;
								do{ 
									menuJuego();
									printf("Seleccione una opcion: ");
									scanf("%d",&opcionJuego);
									printf("\n");
									switch(opcionJuego){

										/*Iniciar  partida*/
										case 1:
											printf("\n-------REPARTIR FICHAS-------\n");
											printf("Por favor, elija una opcion para el tamaño de las fichas \n");
											do{
												menuTamFichas();
												printf("Seleccione una opcion: ");
												scanf("%d",&opcionFichas);
												printf("\n");
												switch(opcionFichas){
													case 1:
														repartir_fichas_1_arg = 16;
														break;
													case 2:
														repartir_fichas_1_arg = 18;
														break;
													case 3:
														repartir_fichas_1_arg = 20;
														break;
													case 4:
														repartir_fichas_1_arg = 22;
														break;
													case 5:
														repartir_fichas_1_arg = 24;
														break;
													case 6:
														repartir_fichas_1_arg = 26;
														break;
													case 7:
														repartir_fichas_1_arg = 28;
														break;
													default:
														printf("Tamaño invalido!.");
														break;
							
												}
											}while(opcionFichas< 1 || opcionFichas > 7);
	
											printf("Nuero de fichas selesccionadas :%d\n", repartir_fichas_1_arg);
											tam_usuario = repartir_fichas_1_arg/2;
											tam_tablero = repartir_fichas_1_arg;
											result_7 = repartir_fichas_1(&repartir_fichas_1_arg, clnt);

											/*Una vez se tiene el tamaño de las fichas que ha elegido el usuario
											* las repartimos para empezar la partida*/

											if (result_7 == (fichas *) NULL) {
												clnt_perror (clnt, "call failed");
											}else{
												printf("\nLas fichas se han repartido...\n");
												printf("Estas son tus Fichas:  \n");
												Imprimir_Fichas(result_7,tam_usuario);
											}

											/*Empieza la partida!
											* empezamos por comprobar quien tiene la ficha 6|6. quien la tiene
											* inicia la partida*/

 											result_8 = empezar_partida_1((void*)&empezar_partida_1_arg, clnt);
											if (result_8 == (fichas *) NULL) {
												clnt_perror (clnt, "call failed");
											
											}else{
												if((*result_8).fichasJugadores[0].id == -1){
													printf("\nINICIA EL USUARIO.....\n");
													printf("\nSeleccione la ficha 6|6 para iniciar la partida: ");
													scanf("%d",&enviar_jugada_1_arg);
													while(enviar_jugada_1_arg != 27){
														printf("Por favor, digite el id de la ficha 6|6: ");
														scanf("%d",&enviar_jugada_1_arg);	
													}
													
													result_9 = enviar_jugada_1(&enviar_jugada_1_arg, clnt);
													if (result_9 == (fichas *) NULL) {
													clnt_perror (clnt, "call failed");
													}else{
														jugadas++;	
														printf("**********  TABLERO  **********\n");
														Imprimir_Fichas(result_9,jugadas);
													}
													/*do{

													}while(result_9);*/	
												}else{
													printf("\nINICIA EL SERVIDOR\n");
													printf("Jugada del servidor: [%d|%d]",(*result_8).fichasJugadores[0].lado_A,
													(*result_8).fichasJugadores[0].lado_B);
													printf("**********  TABLERO  **********\n");
													Imprimir_Fichas(result_9,jugadas);
													jugadas++;
												}
												
												/*Mientras no haya un ganador, o no puedan colocar fichas o empaten 
												* no termina el juego */

												/*
												while(estado partida != condicionTerminada){
												

												}
												*/
												/*do{

												}while(result_9);*/		
											
												int opc = 0;
												int id_ficha=-1;
												do{
													opc = menu_jugando();
													switch(opc){
														case 1:
															//imprimir las fichas del usuario.
															printf("Digite el id de la Ficha a colocar : \n");
															scanf("%d",&id_ficha);
															if(id_ficha < -1 && id_ficha > 27){
														
															}else{

															}
														break;

														case 2:
															printf("Seguro de terminar el juego....\n");
														break;

														default:
															printf("Opcion invalida....\n");
														break;
													}


												} while (opc != 2);

												}//fin else
											break;
										//  >  <
										/*Consultar estadisticas*/
										case 2:

											printf("\n-------CONSULTANDO ESTADISTICAS-------\n");
											result_13 = consultar_estadisticas_1((void*)&consultar_estadisticas_1_arg, clnt);
											if (result_13 == (char **) NULL) {
												clnt_perror (clnt, "call failed");
											}else{
												printf("\nImprimiendo Estadisticas");
												printf("\n %s",*result_13);
											}
											break;

										/*Salir*/
										case 3:
											printf("\nVolviendo al menu de usuario...");
											break;

										default: 
											printf("\nOpcion no valida");
											break;
									}	
								}while(opcionJuego != 3);
							}
							break;

						/*Registrarse*/
						case 2:
							printf("\n-------REGISTRO DE USUARIO-------\n");

							printf("\nDigite nombre del usuario: ");
							scanf("%s", usuarionuevo.nombres);
							fflush(stdin);

							int nnombre = sizeof(usuarionuevo.nombres)/sizeof(char);

							if(nnombre > 30)
							{
								printf("El nombre no debe superar los 30 caracteres!\n");
								break;
							}


							printf("Digite apellido del usuario: ");
							scanf("%s", usuarionuevo.apellidos);
							fflush(stdin);

							int napellido = sizeof(usuarionuevo.apellidos)/sizeof(char);

							if(napellido > 30)
							{
								printf("El apellido no debe superar los 20 caracteres!\n");
								break;
							}

							printf("Digite el login del usuario: ");
							scanf("%d", &usuarionuevo.login);
							fflush(stdin);
							nlogin = sizeof(usuarionuevo.login)/sizeof(int);
							if(nlogin > 10){
								printf("El login no debe superar los 10 caracteres!\n");
								break;
							}

							printf("Digite la contraseña del usuario: ");
							scanf("%s", usuarionuevo.contrasena);
							fflush(stdin);
							ncontrasena = sizeof(usuarionuevo.contrasena)/sizeof(char);
							if(ncontrasena < 8 || ncontrasena > 15){
								printf("La contraseña no puede ser menor a 8 y mayor a 15 caracteres!\n");
								break;
							}
							usuarionuevo.permiso = 1;
							usuarionuevo.nodoSiguiente = NULL;

							registrarusuario_1_arg = &(usuarionuevo);
		
							result_2 = registrarusuario_1(&registrarusuario_1_arg, clnt);
							if (result_2 == (bool_t *) NULL) {
								clnt_perror (clnt, "call failed");
							}else{
								printf("\nUsuario registrado!");
							}
							break;

						/*Salir*/
						case 3:
							printf("\nVolviendo al menu principal...");
							break;

						default:
							printf("\nOpcion no valida");
							break;
					}
				}while(opcionAux != 3);
				break;
				

			case  3:
				result_14 = salir_1((void*)&salir_1_arg, clnt);
				if (result_14 == (bool_t *) NULL) {
					clnt_perror (clnt, "call failed");
				}else{
					printf("\n Hasta pronto!");
				}

				break;
			default :
				printf("Opcion invalida");
				break;
		}

	}while(opcion1 != 3);


/*Hasta aqui llego la copia de las lineas*/
#ifndef	DEBUG
	clnt_destroy (clnt);
#endif	 /* DEBUG */
}


int
main (int argc, char *argv[])
{
	char *host;

	if (argc < 2) {
		printf ("usage: %s server_host\n", argv[0]);
		exit (1);
	}
	host = argv[1];
	gestion_usuario_1 (host);
exit (0);
}
